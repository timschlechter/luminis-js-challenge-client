<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>..&#x2F;app&#x2F;js&#x2F;ChatController.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/ChatController.html">ChatController</a></li>
            
                <li><a href="..&#x2F;classes/WolframAlpha.html">WolframAlpha</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: ..&#x2F;app&#x2F;js&#x2F;ChatController.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
chatApp.controller(&#x27;ChatController&#x27;, [&#x27;$scope&#x27;,	&#x27;$location&#x27;, &#x27;ChatService&#x27;, &#x27;MessageObserver&#x27;, &#x27;WolframAlpha&#x27;,
	&#x2F;**
	 * @class ChatController
	 * @param {$scope}			$scope
	 * @param {$location}		$location
	 * @param {ChatService}		ChatService
	 * @param {MessageObserver}	MessageObserver
	 * @param {WolframAlpha}	WolframAlpha
	 *&#x2F;
	function ChatController($scope, $location, ChatService, MessageObserver, WolframAlpha) {

		&#x2F;&#x2F; Authenticated?
		if (!ChatService.authenticatedUser)
			return $location.path(&quot;&#x2F;login&quot;);

		$scope.currentUser = ChatService.authenticatedUser;
		$scope.users = [];
		$scope.chats = [];
		$scope.selectedChat = null;
		$scope.selectedUser = null;

		$scope.wolframAlphaStarted = false;

		&#x2F;**
		 * @method selectUser
		 * @param  {[type]} user
		 * @return {[type]}
		 *&#x2F;
		$scope.selectUser = function (user) {
			$scope.selectedUser = user;
			$scope.selectedChat = $scope.openChat($scope.currentUser, user);
		};

		$scope.openChat = function (sender, recipient) {

			if (!sender || !recipient)
				return null;

			var chat = $scope.findChat(sender, recipient);

			&#x2F;&#x2F; Create a new chat if it doesn&#x27;t exist
			if (!chat) {
				chat = {
					sender : sender,
					recipient : recipient,
					messages : [],
					lastMessageReceived : null,
					recieveMessage : function (message) {
						var lastMessage = _.last(chat.messages);

						&#x2F;&#x2F; Muted
						if (this.sender.muted)
							return;

						&#x2F;&#x2F; First message or newest message
						if (chat.messages.length === 0 || lastMessage.id &lt; message.id) {
							chat.messages.push(message);
						} else {
							&#x2F;&#x2F; Ensure messages are sorted chronological
							for (var i = 0; i &lt; chat.messages.length; i++) {
								var currentMessage = chat.messages[i];

								&#x2F;&#x2F; Allready got the message
								if (currentMessage.id === message.id)
									return;

								if (message.id &lt; currentMessage.id) {
									&#x2F;&#x2F; Add message before currentMessage
									chat.messages.splice(i, 0, message);
									return;
								}
							}
						}

						&#x2F;&#x2F; force update of bindings
						if(!$scope.$$phase) {
							$scope.$apply();
						}
					}
				};

				&#x2F;&#x2F; Subscribe to messages observer
				MessageObserver.subscribe(chat, chat.recipient.name, chat.sender.name, chat.recieveMessage);
				MessageObserver.subscribe(chat, chat.sender.name, chat.recipient.name, chat.recieveMessage);

				$scope.chats.push(chat);
			}

			&#x2F;&#x2F; Reset user&#x27;s new messsages list
			chat.recipient.newMessages = null;

			$scope.selectedChat = chat;

			return chat;
		};

		$scope.closeChat = function (chat) {
			$scope.chats = _.without($scope.chats, chat);

			&#x2F;&#x2F; Unsubscribe from messages observer
			MessageObserver.unsubscribe(chat, chat.recipient.name, $scope.currentUser.name);
			MessageObserver.unsubscribe(chat, $scope.currentUser.name, chat.recipient.name);

			if ($scope.selectedChat === chat) {
				&#x2F;&#x2F; Set selection to first chat&#x27;s user
				var firstChat = $scope.chats[0],
					user = firstChat ? firstChat.user : null;

				$scope.selectUser(user);
			}
		};

		$scope.sendMessage = function (chat, text) {
			if (!chat)
				return;

			ChatService.sendMessage(chat.sender.name, chat.recipient.name, text);

			$scope.text = &#x27;&#x27;;
		};

		$scope.toggleMute = function (user) {
			var chat = $scope.findChat($scope.currentUser, user);

			user.muted = !user.muted;
		};

		$scope.findUser = function (name) {
			return _.find($scope.users, function (user) { return user.name === name; });
		};

		$scope.findChat = function (sender, recipient) {
			return _.find($scope.chats, function (chat) { return chat.sender === sender &amp;&amp; chat.recipient === recipient; });
		};

		$scope.logout = function () {

			destroy();

			$location.path(&quot;&#x2F;login&quot;);
		};

		$scope.toggleWolframAlpha = function() {
			if ($scope.wolframAlphaStarted)
				WolframAlpha.stop();
			else
				WolframAlpha.start();

			$scope.wolframAlphaStarted = !$scope.wolframAlphaStarted;
		};

		function addUser(user) {
			user.isCurrentUser = $scope.currentUser.name === user.name;
			$scope.users.push(user);
		}

		function recieveMessage(message) {
			var sender = $scope.findUser(message.sender),
				selectedUser = $scope.selectedUser;

			&#x2F;&#x2F; Muted
			if (sender.muted)
				return;

			&#x2F;&#x2F; If message is new, add it to the user&#x27;s newMessages
			if (!sender.lastMessageReceived || sender.lastMessageReceived.id &lt; message.id) {

				&#x2F;&#x2F; Only update newMessages when sender is not selectedUser
				if (!selectedUser || sender.name !== selectedUser.name) {

					if (!sender.newMessages)
						sender.newMessages = [];

					sender.newMessages.push(message);
				}

				&#x2F;&#x2F; Update 
				sender.lastMessageReceived = message;
			}
		}

		function init() {

			ChatService.getUsers()
				.success(function (users) {
					_.each(users, addUser);

					&#x2F;&#x2F; Subscribe to messages observer
					MessageObserver.subscribe(this, undefined, $scope.currentUser.name, recieveMessage);
				});

			MessageObserver.start();
		}

		function destroy() {

			MessageObserver.stop();

			WolframAlpha.stop();

			&#x2F;&#x2F; Close all chats
			_.each($scope.chats, function (chat) { $scope.closeChat(chat); });

			&#x2F;&#x2F; Unsubscribe
			MessageObserver.unsubscribe(this, undefined, $scope.currentUser.name);

			ChatService.logout();
		}

		init();
    }
]);
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
